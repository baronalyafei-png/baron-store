<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Baron Admin Panel</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{margin:0;font-family:Arial;background:#0A0A0A;color:#EFEFEF;display:flex}
.sidebar{width:250px;background:#111;height:100vh;padding:20px;box-shadow:0 0 20px rgba(181,60,184,0.3)}
.sidebar h2{text-align:center;margin-bottom:30px}
.sidebar button{width:100%;margin-bottom:10px;padding:10px;background:none;border:1px solid #B53CB8;color:#EFEFEF;border-radius:8px;cursor:pointer}
.sidebar button:hover{background:#B53CB8}
.content{flex:1;padding:30px;overflow-y:auto}
.section{display:none}
.section.active{display:block}
.stat-box{background:#111;padding:20px;border-radius:12px;margin-bottom:20px;box-shadow:0 0 20px rgba(181,60,184,0.3)}
.notification{background:#2a0f0f;border:1px solid red;padding:15px;border-radius:10px;margin-bottom:20px;color:#ff8080}
.card{background:#111;padding:15px;border-radius:10px;margin-bottom:15px}
.low-stock{border:1px solid red}
.logout{margin-top:30px;background:#444!important}
canvas{background:#111;padding:20px;border-radius:12px;margin-top:20px}
input,select{padding:8px;border-radius:8px;background:#111;color:#EFEFEF;border:1px solid #B53CB8;margin-bottom:10px;width:100%}
button.action{background:#B53CB8;border:none;padding:8px 12px;color:white;border-radius:8px;margin-top:5px;cursor:pointer}
</style>
</head>

<body>

<div class="sidebar">
<h2>Baron ğŸ‘‘</h2>
<button onclick="showSection('dashboard')">ğŸ“Š Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª</button>
<button onclick="showSection('inventory')">ğŸ“¦ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</button>
<button onclick="showSection('subscriptions')">ğŸ’³ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª</button>
<button onclick="showSection('orders')">ğŸ›’ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</button>
<button id="logoutBtn" class="logout">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
</div>

<div class="content">

<!-- Analytics -->
<div id="dashboard" class="section active">
<h1>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª</h1>

<select id="periodFilter" onchange="loadAnalytics()">
<option value="7">Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…</option>
<option value="30">Ø¢Ø®Ø± 30 ÙŠÙˆÙ…</option>
<option value="all">ÙƒÙ„ Ø§Ù„ÙˆÙ‚Øª</option>
</select>

<div id="notificationArea"></div>

<div class="stat-box">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª: <span id="totalSales">0</span></div>

<canvas id="salesChart"></canvas>
<canvas id="ordersChart"></canvas>
<canvas id="stockChart"></canvas>
</div>

<!-- Inventory -->
<div id="inventory" class="section">
<h1>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</h1>
<div id="inventoryList"></div>
</div>

<!-- Subscriptions -->
<div id="subscriptions" class="section">
<h1>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª</h1>

<input type="text" id="subName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ">
<input type="number" id="subPrice" placeholder="Ø§Ù„Ø³Ø¹Ø±">
<input type="text" id="subDuration" placeholder="Ø§Ù„Ù…Ø¯Ø©">
<input type="text" id="subType" placeholder="Ø§Ù„Ù†ÙˆØ¹">

<button class="action" onclick="addSubscription()">Ø¥Ø¶Ø§ÙØ© Ø§Ø´ØªØ±Ø§Ùƒ</button>

<h3 style="margin-top:20px;">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª</h3>
<div id="subList"></div>
</div>

<!-- Orders -->
<div id="orders" class="section">
<h1>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h1>
<div id="ordersContainer"></div>
</div>

</div>

<script type="module">

import { auth, db } from "../firebase-config.js";
import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { collection, getDocs, addDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

let salesChart, ordersChart, stockChart;

onAuthStateChanged(auth,(user)=>{
    if(!user){window.location.href="login.html";}
});

document.getElementById("logoutBtn").addEventListener("click",()=>{
    signOut(auth).then(()=>{window.location.href="login.html";});
});

window.showSection = function(id){
    document.querySelectorAll(".section").forEach(sec=>sec.classList.remove("active"));
    document.getElementById(id).classList.add("active");
};

async function loadAnalytics(){
    const period=document.getElementById("periodFilter").value;
    const now=new Date();
    const productsSnap=await getDocs(collection(db,"products"));
    const ordersSnap=await getDocs(collection(db,"orders"));

    let totalSales=0, salesData={}, ordersData={}, lowStock=0;

    productsSnap.forEach(doc=>{
        if(doc.data().stock<=5) lowStock++;
    });

    document.getElementById("notificationArea").innerHTML=
    lowStock>0?`<div class="notification">âš  ÙŠÙˆØ¬Ø¯ ${lowStock} Ù…Ù†ØªØ¬Ø§Øª Ù…Ù†Ø®ÙØ¶Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</div>`:"";

    ordersSnap.forEach(doc=>{
        const o=doc.data();
        const dateObj=o.createdAt.toDate();
        const diffDays=(now-dateObj)/(1000*60*60*24);

        if(period==="7"&&diffDays>7)return;
        if(period==="30"&&diffDays>30)return;

        const date=dateObj.toLocaleDateString();
        salesData[date]=(salesData[date]||0)+o.total;
        ordersData[date]=(ordersData[date]||0)+1;
        totalSales+=o.total;
    });

    document.getElementById("totalSales").innerText=totalSales+" Ø¯.Ù„";

    createChart("salesChart","Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª",salesData,"#B53CB8",salesChart,c=>salesChart=c);
    createChart("ordersChart","Ø§Ù„Ø·Ù„Ø¨Ø§Øª",ordersData,"#00c2ff",ordersChart,c=>ordersChart=c);

    let stockLabels={}, stockValues={};
    productsSnap.forEach(doc=>{
        stockLabels[doc.data().name]=doc.data().stock;
    });

    createChart("stockChart","Ø§Ù„Ù…Ø®Ø²ÙˆÙ†",stockLabels,"#ff9800",stockChart,c=>stockChart=c);
}

function createChart(canvasId,label,dataObj,color,existingChart,setter){
    if(existingChart) existingChart.destroy();
    const labels=Object.keys(dataObj);
    const values=Object.values(dataObj);

    const chart=new Chart(document.getElementById(canvasId),{
        type:'bar',
        data:{labels:labels,datasets:[{label:label,data:values,backgroundColor:color}]},
        options:{
            plugins:{legend:{labels:{color:"#EFEFEF"}}},
            scales:{x:{ticks:{color:"#EFEFEF"}},y:{ticks:{color:"#EFEFEF"}}}
        }
    });
    setter(chart);
}

async function loadInventory(){
    const snapshot=await getDocs(collection(db,"products"));
    inventoryList.innerHTML="";
    snapshot.forEach(doc=>{
        const p=doc.data();
        const lowClass=p.stock<=5?"low-stock":"";
        inventoryList.innerHTML+=`<div class="card ${lowClass}">${p.name} â€” Ø§Ù„ÙƒÙ…ÙŠØ©: ${p.stock}</div>`;
    });
}

async function loadOrders(){
    const snapshot=await getDocs(collection(db,"orders"));
    ordersContainer.innerHTML="";
    snapshot.forEach(doc=>{
        const o=doc.data();
        ordersContainer.innerHTML+=`<div class="card">${o.customerName} - ${o.total} Ø¯.Ù„ - ${o.status}</div>`;
    });
}

window.addSubscription=async function(){
    const name=subName.value;
    const price=Number(subPrice.value);
    const duration=subDuration.value;
    const type=subType.value;

    if(!name||!price||!duration||!type){alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");return;}

    await addDoc(collection(db,"subscriptions"),{name,price,duration,type,createdAt:new Date()});
    subName.value="";subPrice.value="";subDuration.value="";subType.value="";
    loadSubscriptions();
};

async function loadSubscriptions(){
    const snapshot=await getDocs(collection(db,"subscriptions"));
    subList.innerHTML="";
    snapshot.forEach(docSnap=>{
        const s=docSnap.data();
        subList.innerHTML+=`
        <div class="card">
        ${s.name} - ${s.price} Ø¯.Ù„ - ${s.duration}
        <button class="action" onclick="deleteSubscription('${docSnap.id}')">Ø­Ø°Ù</button>
        </div>`;
    });
}

window.deleteSubscription=async function(id){
    await deleteDoc(doc(db,"subscriptions",id));
    loadSubscriptions();
};

loadAnalytics();
loadInventory();
loadOrders();
loadSubscriptions();

</script>

</body>
</html>
