<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Baron Admin Panel</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{margin:0;font-family:Arial;background:#0A0A0A;color:#EFEFEF;display:flex}
.sidebar{width:260px;background:#111;height:100vh;padding:20px;box-shadow:0 0 20px rgba(181,60,184,0.3)}
.sidebar h2{text-align:center;margin-bottom:30px}
.sidebar button{width:100%;margin-bottom:10px;padding:10px;background:none;border:1px solid #B53CB8;color:#EFEFEF;border-radius:8px;cursor:pointer}
.sidebar button:hover{background:#B53CB8}
.content{flex:1;padding:30px;overflow-y:auto}
.section{display:none}
.section.active{display:block}
.card{background:#111;padding:15px;border-radius:10px;margin-bottom:15px}
input,select{width:100%;padding:8px;margin-bottom:10px;border-radius:8px;border:1px solid #B53CB8;background:#111;color:#EFEFEF}
button.action{background:#B53CB8;border:none;padding:8px 12px;color:white;border-radius:8px;margin-top:5px;cursor:pointer}
.logout{margin-top:30px;background:#444!important}
</style>
</head>

<body>

<div class="sidebar">
<h2>Baron ğŸ‘‘</h2>
<button onclick="showSection('invoices')">ğŸ§¾ Ø§Ù„ÙÙˆØ§ØªÙŠØ±</button>
<button id="logoutBtn" class="logout">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
</div>

<div class="content">

<div id="invoices" class="section active">

<h1>Ù†Ø¸Ø§Ù… Ø§Ù„ÙÙˆØ§ØªÙŠØ± ÙˆØ§Ù„Ø¥Ø¯Ø§Ø±Ø©</h1>

<h3>Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ±Ø¯</h3>
<input type="text" id="supplierName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯">
<button class="action" onclick="addSupplier()">Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ±Ø¯</button>
<div id="supplierList"></div>

<hr>

<h3>Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø¯ÙˆØ¨ Ù…Ø¨ÙŠØ¹Ø§Øª</h3>
<input type="text" id="agentName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨">
<button class="action" onclick="addAgent()">Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø¯ÙˆØ¨</button>
<div id="agentList"></div>

<hr>

<h3>ÙØ§ØªÙˆØ±Ø© Ù…ÙˆØ±Ø¯ (Ø²ÙŠØ§Ø¯Ø© Ù…Ø®Ø²ÙˆÙ†)</h3>
<select id="supplierSelect"></select>
<select id="productSelect"></select>
<input type="number" id="invoiceQty" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©">
<input type="number" id="invoiceCost" placeholder="ØªÙƒÙ„ÙØ© Ø§Ù„ÙˆØ­Ø¯Ø©">
<button class="action" onclick="createSupplierInvoice()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button>

<hr>

<h3>ØªØ³Ù„ÙŠÙ… Ø¨Ø¶Ø§Ø¹Ø© Ù„Ù…Ù†Ø¯ÙˆØ¨</h3>
<select id="agentSelect"></select>
<select id="agentProductSelect"></select>
<input type="number" id="agentQty" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©">
<button class="action" onclick="deliverToAgent()">ØªØ³Ù„ÙŠÙ…</button>

<div id="logArea"></div>

</div>

</div>

<script type="module">

import { auth, db } from "../firebase-config.js";
import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { collection, addDoc, getDocs, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

onAuthStateChanged(auth,(user)=>{
    if(!user){window.location.href="login.html";}
});

document.getElementById("logoutBtn").addEventListener("click",()=>{
    signOut(auth).then(()=>{window.location.href="login.html";});
});

window.showSection = function(id){
    document.querySelectorAll(".section").forEach(sec=>sec.classList.remove("active"));
    document.getElementById(id).classList.add("active");
};

async function loadInitialData(){
    const suppliers=await getDocs(collection(db,"suppliers"));
    supplierSelect.innerHTML="";
    supplierList.innerHTML="";
    suppliers.forEach(doc=>{
        supplierSelect.innerHTML+=`<option value="${doc.id}">${doc.data().name}</option>`;
        supplierList.innerHTML+=`<div class="card">${doc.data().name}</div>`;
    });

    const agents=await getDocs(collection(db,"agents"));
    agentSelect.innerHTML="";
    agentList.innerHTML="";
    agents.forEach(doc=>{
        agentSelect.innerHTML+=`<option value="${doc.id}">${doc.data().name}</option>`;
        agentList.innerHTML+=`<div class="card">${doc.data().name}</div>`;
    });

    const products=await getDocs(collection(db,"products"));
    productSelect.innerHTML="";
    agentProductSelect.innerHTML="";
    products.forEach(doc=>{
        productSelect.innerHTML+=`<option value="${doc.id}">${doc.data().name}</option>`;
        agentProductSelect.innerHTML+=`<option value="${doc.id}">${doc.data().name}</option>`;
    });
}

window.addSupplier = async function(){
    await addDoc(collection(db,"suppliers"),{name:supplierName.value});
    supplierName.value="";
    loadInitialData();
};

window.addAgent = async function(){
    await addDoc(collection(db,"agents"),{name:agentName.value,debt:0});
    agentName.value="";
    loadInitialData();
};

window.createSupplierInvoice = async function(){
    const productRef=doc(db,"products",productSelect.value);
    const snap=await getDocs(collection(db,"products"));
    const productSnap=await (await fetchProduct(productSelect.value));
    const currentStock=productSnap.stock;

    await updateDoc(productRef,{stock:currentStock + Number(invoiceQty.value)});

    await addDoc(collection(db,"supplierInvoices"),{
        supplierId:supplierSelect.value,
        productId:productSelect.value,
        qty:Number(invoiceQty.value),
        cost:Number(invoiceCost.value),
        createdAt:new Date()
    });

    logArea.innerHTML="<div class='card'>ØªÙ… ØªØ³Ø¬ÙŠÙ„ ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…ÙˆØ±Ø¯ ÙˆØ²ÙŠØ§Ø¯Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</div>";
};

async function fetchProduct(id){
    const products=await getDocs(collection(db,"products"));
    for(const doc of products.docs){
        if(doc.id===id) return doc.data();
    }
}

window.deliverToAgent = async function(){
    const productRef=doc(db,"products",agentProductSelect.value);
    const productSnap=await fetchProduct(agentProductSelect.value);
    if(productSnap.stock < agentQty.value){
        alert("Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ØºÙŠØ± ÙƒØ§ÙÙ");
        return;
    }

    await updateDoc(productRef,{stock:productSnap.stock - Number(agentQty.value)});

    await addDoc(collection(db,"agentDeliveries"),{
        agentId:agentSelect.value,
        productId:agentProductSelect.value,
        qty:Number(agentQty.value),
        createdAt:new Date()
    });

    logArea.innerHTML="<div class='card'>ØªÙ… ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø© Ù„Ù„Ù…Ù†Ø¯ÙˆØ¨</div>";
};

loadInitialData();

</script>

</body>
</html>
