<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø´Ø±Ø§Ø¡</title>
<style>
body{background:#0A0A0A;color:#EFEFEF;font-family:Arial;padding:20px}
input,textarea{width:100%;padding:10px;margin:10px 0;border:none;border-radius:8px}
button{width:100%;padding:12px;background:#B53CB8;border:none;color:white;border-radius:8px}
</style>
</head>
<body>

<h1>Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø´Ø±Ø§Ø¡ ðŸ’³</h1>

<input type="text" id="customerName" placeholder="Ø§Ù„Ø§Ø³Ù…">
<input type="text" id="customerPhone" placeholder="Ø§Ù„Ù‡Ø§ØªÙ">
<textarea id="customerAddress" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†"></textarea>

<div id="total"></div>
<button onclick="submitOrder()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨</button>

<script type="module">
import { db } from "./firebase-config.js";
import { collection, addDoc, doc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

let cart = JSON.parse(localStorage.getItem("cart")) || [];
let total = 0;
cart.forEach(i=> total+=i.price);
document.getElementById("total").innerText="Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: "+total+" Ø¯.Ù„";

window.submitOrder = async function(){

    const name = customerName.value;
    const phone = customerPhone.value;
    const address = customerAddress.value;

    if(!name || !phone || !address){
        alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
        return;
    }

    // Ø®ØµÙ… Ø§Ù„ÙƒÙ…ÙŠØ© Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
    for(let item of cart){
        const ref = doc(db,"products",item.id);
        const snap = await getDoc(ref);
        if(snap.exists()){
            const currentStock = snap.data().stock;
            await updateDoc(ref,{stock: currentStock - 1});
        }
    }

    await addDoc(collection(db,"orders"),{
        customerName:name,
        customerPhone:phone,
        customerAddress:address,
        items:cart,
        total:total,
        status:"Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯",
        createdAt:new Date()
    });

    alert("ØªÙ… Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­ ðŸ‘‘");
    localStorage.removeItem("cart");
    window.location.href="store.html";
};
</script>

</body>
</html>
